<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
	<head>
		<meta http-equiv="content-type" content="text/html;charset=utf-8" />
		<title>一个集群管理 bash 脚本示例 - xanpeng</title>
		<link rel="stylesheet" type="text/css" href="/css/style.css" />
		<link rel="stylesheet" type="text/css" href="/css/syntax.css" />
	</head>

	<body>
		<div id="wrapper">
			<div id="content">
				<h2>一个集群管理 bash 脚本示例</h2>
				<div class="cnt">
					<p>编写一个集群管理脚本(<strong>cm.sh</strong>)的目的是:</p>

<ul>
<li>保证集群中每个节点的环境是一致的.</li>
<li>减少人工操作, 省时省心.</li>
</ul>


<p>以重新安装模块为例, 任务: 开发调试后, 重编内核模块, 要在集群中验证功能, 需要替换原来的模块, 安装新的模块.</p>

<p>功能上需要保证:</p>

<ul>
<li>旧模块被卸载, 新的模块成功加入, 而且使用的是新模块.</li>
</ul>


<p>对 cm.sh 的需求:</p>

<ul>
<li>抑制 ssh 登录的 banner: <code>ssh -q</code> (<a href="http://serverfault.com/questions/66986/suppressing-ssh-banner-from-openssh-client">ref</a>)</li>
<li>抑制 motd: <code>touch ~/.hushlogin</code> (<a href="http://www.debian-administration.org/articles/546">ref1</a>, <a href="http://serverfault.com/questions/36421/stop-ssh-login-from-printing-motd-from-the-client">ref2</a>)</li>
<li>方便修改: 定义变量, 使用 loop.</li>
<li>支持输入 option: 定义函数, 使用 case.</li>
<li>支持并行发送命令: <code>ssh -f</code> ----> 实际表明, 使用 -f 的效果不如使用 "<strong>&amp;</strong>"</li>
<li>支持等待某些进程执行完成, 好处是显示不会错乱+用户能感知完成: 使用 <code>wait</code> 指定进程号.</li>
</ul>


<p><em>1,2 两步的目的是让 ssh 没有多余的输出.</em></p>

<p>cm.sh 执行前的假设:</p>

<ul>
<li>cm.sh 放置的节点作为 master 节点, 它生产最原始的数据, 并分发给其他节点.</li>
<li>每个节点的目录结构是一致的: 源码路径一致, ko 放置位置一致.</li>
<li>已经创建了 ~/.hushlogin 文件.</li>
<li>建立了 master 对其他节点的 <a href="http://rcsg-gsir.imsb-dsgi.nrc-cnrc.gc.ca/documents/internet/node31.html">password-less login</a></li>
</ul>


<p>cm.sh</p>

<script src="https://gist.github.com/2479091.js"> </script>


<p>一個更好的腳本 better-cm.sh</p>

<script src="https://gist.github.com/2500303.js"> </script>




					--EOF--
				</div>
				<div id="disqus_thread"></div>
				<script type="text/javascript">
				  (function() {
				   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				   dsq.src = 'http://xanpeng.disqus.com/embed.js';
				   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
				  })();
				</script>
				<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=lzyyblog">comments powered by Disqus.</a></noscript>
			</div>
	</body>
</html>

