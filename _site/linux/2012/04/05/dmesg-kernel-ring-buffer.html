<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
	<head>
		<meta http-equiv="content-type" content="text/html;charset=utf-8" />
		<title>Linux kernel ring buffer 和 dmesg - xanpeng</title>
		<link rel="stylesheet" type="text/css" href="/css/style.css" />
		<link rel="stylesheet" type="text/css" href="/css/syntax.css" />
	</head>

	<body>
		<div id="wrapper">
			<div id="content">
				<h2>Linux kernel ring buffer 和 dmesg</h2>
				<div class="cnt">
					<p>dmesg为我们多用，<code>man dmesg</code>告知dmesg用来显示和管理kernel ring buffer，那么后者为何物，以及dmesg显示何类信息，是本文待阐述的内容。</p>

<p>documentation/trace/ring-buffer-design.txt包含了详细的设计方案<em>(看来documentation下的内容应是后续查找tutor的首选)</em>，
其中细节不是目前所需，但看起来却是是设计<strong>无锁(lockless)</strong>日志系统的绝佳参考资料。</p>

<p>ring buffer（rb）和kernel ring buffer（krb）是不同的东西，前者泛指一类buffer设计方案，后者特指Linux内核使用的ring buffer。</p>

<p>rb有两种模式：<br/>
1、producer/consumer模式：如果生产的太多，没有来得及消费，“仓库”占满了，那么就暂停生产--这种模式可能会丢失最近的事件记录。<br/>
2、overwrite模式：生产者填满“仓库”的时候，它仍然继续生产，并覆盖最旧的事件记录--这种模式可能会丢失最旧的事件记录。</p>

<p>krb位于内核(对应于/proc/kmsg)，又称之为Kernel Log Buffer，包含和内核、内核模块相关的消息，如装载新模块的消息、注册新的文件系统的消息等。这些消息被划分为不同的级别：<br/>
- LOG_EMERG system is unusable<br/>
- LOG_ALERT action must be taken immediately<br/>
- LOG_CRIT critical conditions<br/>
- LOG_ERR error conditions<br/>
- LOG_WARNING warning conditions<br/>
- LOG_NOTICE normal, but significant, condition<br/>
- LOG_INFO informational message<br/>
- LOG_DEBUG debug-level message</p>

<p>kernel日志(如printk的数据)视情况发往不同的地方：<br/>
- 如果klogd和syslogd都在运行，kernel messages被写到/var/log/messages的末尾(或者syslogd配置给定的地方)，此时和级别无关，所有级别日志信息都写入。<br/>
- 如果klogd没有运行，消息不会发往用户空间(不会写messages文件?)，除非显式读取/proc/kmsg(一般通过kmsg)。</p>

<p>读取krb的首选方案是dmesg，dmesg其实是通过系统调用syslog去读取的。</p>

<p>参考资料中的“Kernel logging: APIs and implementation”包含了一些图片，直观展示了krb及其上的操作。</p>

<p>dmesg的输出和/var/log/messages的内容有什么区别呢？它们有父子集的关系吗？<br/>
我在unix.stackexchange上<a href="http://unix.stackexchange.com/questions/35851/whats-the-difference-of-dmesg-output-and-var-log-messages">问了这个问题</a>，但目前还没得到满意的答案。</p>

<p>参考<br/>
- <a href="http://www.web-manual.net/linux-3/the-kernel-ring-buffer-and-dmesg/">Kernel ring buffer and dmesg</a><br/>
- <a href="http://stackoverflow.com/questions/9533708/how-to-read-ring-buffer-within-linux-kernel-space">How to read ring buffer within linux kernel space?</a><br/>
- <a href="http://www.makelinux.net/ldd3/chp-4-sect-2">Debugging by Printing</a><br/>
- <a href="http://www.ibm.com/developerworks/linux/library/l-kernel-logging-apis/index.html"><strong>Kernel logging: APIs and implementation</strong></a><br/>
- <a href="http://askubuntu.com/questions/26237/difference-between-var-log-messages-var-log-syslog-and-var-log-kern-log">Difference between /var/log/messages, /var/log/syslog, and /var/log/kern.log?</a></p>

					--EOF--
				</div>
				<div id="disqus_thread"></div>
				<script type="text/javascript">
				  (function() {
				   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				   dsq.src = 'http://xanpeng.disqus.com/embed.js';
				   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
				  })();
				</script>
				<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=lzyyblog">comments powered by Disqus.</a></noscript>
			</div>
	</body>
</html>

