<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
	<head>
		<meta http-equiv="content-type" content="text/html;charset=utf-8" />
		<title>GNU build systems 之 autoconf - xanpeng</title>
		<link rel="stylesheet" type="text/css" href="/css/style.css" />
		<link rel="stylesheet" type="text/css" href="/css/syntax.css" />
	</head>

	<body>
		<div id="wrapper">
			<div id="content">
				<h2>GNU build systems 之 autoconf</h2>
				<div class="cnt">
					<p>在很多开源 C/C++ 项目中都会遇到 configure 和 Makefile, 这些项目使用 GNU build system 管理.<br/>
<a href="http://en.wikipedia.org/wiki/GNU_build_system">GNU build system</a> 又称之为 Autotools, 它包含 <a href="http://en.wikipedia.org/wiki/Autoconf">autoconf</a>, <a href="http://en.wikipedia.org/wiki/Automake">automake</a>, <a href="http://en.wikipedia.org/wiki/Libtool">libtool</a> 这三部分. <a href="http://book.douban.com/subject/3912140/">有一本书</a>专门介绍这些工具集的使用, 这本书也有 <a href="http://sourceware.org/autobook/autobook/autobook.html">online html 版本</a>.</p>

<p><strong>我们為什麼需要使用 Autotools?</strong><br/>
short answer: portability.<br/>
摘抄自 wiki 上的一段话:</p>

<blockquote><p>It can be difficult to make a software program portable: the C compiler differs from system to system; certain library functions are missing on some systems; header files may have different names. One way to handle this is write conditional code, with code blocks selected by means of preprocessor directives (#ifdef); but because of the wide variety of build environments this approach quickly becomes unmanageable. The GNU build system is designed to address this problem more manageably.</p></blockquote>

<p><strong>开源项目如何做到更好的 portability?</strong><br/>
常见的开源软件编译安装步骤:</p>

<pre><code>$ ./configure -OPTIONS
$ make
\# make install
</code></pre>

<p><a href="http://en.wikipedia.org/wiki/Configure_script_(computing">configure 脚本</a>)检查程序依赖的 libs 等.<br/>
make 根据 Makefile 编译整个 project, 生成可执行文件.</p>

<p><strong>configure 脚本如何得来? Makefile 如何得来?</strong><br/>
答案1: 手写.<br/>
答案2: 利用工具生成, 手写最基础直白的规则, 并且表达方式是便于理解的.<br/>
人们总是会选择答案2. GNU build system 就是答案2.</p>

<p><strong>图示</strong><br/>
<img src="http://upload.wikimedia.org/wikipedia/commons/8/84/Autoconf-automake-process.svg" alt="alt GNU build system" /></p>

<p><strong>如何得到 configure 脚本</strong><br/>
autoconf 完成这部分工作.<br/>
其中最基础的一步, 是根据预定义的一个 "checklist", 使用 autoscan 扫描 project 文件夹, 生成 GNU M4 格式的 configure.scan.<br/>
这个 checklist 是 <strong>/usr/share/autoconf/autoscan/autoscan.list</strong><br/>
autoscan.list 是最重要的信息, 其内容大致为:</p>

<blockquote><p>function: gethostname AC_CHECK_FUNCS<br/>
function: gethrtime AC_CHECK_FUNCS<br/>
function: getmntent AC_CHECK_FUNCS<br/>
function: getmntent AC_FUNC_GETMNTENT<br/>
function: getmntinfo AC_CHECK_FUNCS<br/>
function: getpagesize AC_CHECK_FUNCS<br/>
function: getpass AC_CHECK_FUNCS<br/>
function: getspnam AC_CHECK_FUNCS<br/>
function: <strong>gettimeofday</strong> AC_CHECK_FUNCS<br/>
function: getusershell AC_CHECK_FUNCS<br/>
function: getwd warn: getwd is deprecated, use getcwd instead<br/>
function: hasmntopt AC_CHECK_FUNCS<br/>
function: inet_ntoa AC_CHECK_FUNCS</p></blockquote>

<p>其中 gettimeofday 便是典型的会带来 portability 问题的函数了.</p>

<p>其他命令, 这里不再细述, 它们多是 perl 脚本或 shell 脚本:</p>

<pre><code>xan@xmachine:/usr/bin$ file auto*
autoconf: POSIX shell script text executable
autoconf2.64: POSIX shell script text executable
autoheader: a /usr/bin/perl script text executable
autoheader2.64: a /usr/bin/perl script text executable
autoinst: symbolic link to '../share/texmf-texlive/scripts/fontools/autoinst'
autom4te: a /usr/bin/perl -w script text executable
autom4te2.64: a /usr/bin/perl -w script text executable
automake: symbolic link to '/etc/alternatives/automake'
automake-1.10: a /usr/bin/perl -w script text executable
autoreconf: a /usr/bin/perl -w script text executable
autoreconf2.64: a /usr/bin/perl -w script text executable
autoscan: a /usr/bin/perl -w script text executable
autoscan2.64: a /usr/bin/perl -w script text executable
autoupdate: a /usr/bin/perl -w script text executable
autoupdate2.64: a /usr/bin/perl -w script text executable
</code></pre>

					--EOF--
				</div>
				<div id="disqus_thread"></div>
				<script type="text/javascript">
				  (function() {
				   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				   dsq.src = 'http://xanpeng.disqus.com/embed.js';
				   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
				  })();
				</script>
				<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=lzyyblog">comments powered by Disqus.</a></noscript>
			</div>
	</body>
</html>

