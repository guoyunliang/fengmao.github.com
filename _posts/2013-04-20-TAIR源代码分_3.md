---
title: 【Tair源代码分析<3>】
layout: post
category: tair
---
###写在最前面
在<a href="http://my.oschina.net/tfengmao/blog/111400" target="_blank">分布式缓存系统TAIR代码分析&lt;二&gt;</a>中，描述了configserver创建对照表的过程。本文将阐述tair是如何完成数据迁移的。
</p>
##2.6  Tair数据迁移的机制
在分布式系统里，如何保证数据安全? 通常的办法是对数据进行多备份存储。Tair也不例外，以bucket为单位进行多备份存储，保证数据安全。Tair的数据备份数是可配置的，当配置项copyCount为1的时候，表示系统中只保存一份数据，不存在备份，这种情况下，是不需要数据迁移功能的。当copyCount大于1的时候，并且配置了允许数据迁移，那么数据迁移的功能才会在必要的时候发挥作用。
</p>
<p>
本文为了描述Tair数据迁移机制，假定配置项中copyCount&gt;1,且允许数据迁移。章节安排如下：2.6.1节描述Tair系统为什么需要数据迁移；2.6.2节描述 （这里先空下，现在也不确定。写出来，简明易懂，还是比较有挑战的，特别是对我这样不善于玩文字的人来说~~）。
</p>
###2.6.1 为什么需要数据迁移

在创建对照表的章节中，我们知道master bucket和slave bucket是不会全部存储在同一个物理节点上的。当某一个物理节点不可用后，那么存储在这个节点上的所有bucket都会丢失。在这些丢失的bucket中，有master bucket和slave bucket。若master bucket丢失后，该bucket的某个slave bucket会变成master bucket；那么，系统为了保证每个bucket存储copyCount份，会在其他可用节点上创建一个bucket, 进行数据迁移（复制）。

###2.6.2 数据迁移触发条件

首先，可通过配置文件来决定是否允许系统发生数据迁移。下文讨论中，均假设允许数据迁移。<span style="line-height:1.5;font-size:10pt;">我们知道，当可用节点发生变化后（有意或意外添加/减少可用节点会导致可用节点发生变化），configserver会重建对照表。回忆下创建对照表那节，每次创建对照表会输出3张表，其中将一张描述当前bucket分布的对照表，和一张描述迁移完成后的bucket分布的对照表发给每一个物理节点。

新创建的对照表后，configserver与节点之间通过心跳包将新的对照表，对照表版本号以及其他信息发送给存储节点。在2.5.*节中，阐述了对照表如何创建的，这里，强调了对照表何时发送给存储节点的。另外一方面，configserver需要记录哪些节点要完成数据迁移工作。相当于，作为管理者，它要作一个记录，否则，它无法知道系统是否干完了数据迁移的活。


按照2.5节的假设，现在又对照表如表2所示，从左到右，依次为hash_table, m_hash_table和d_hash_table。假设节点D意外不可用，那么configserver检测到节点D不可用后，触发重建对照表过程。假设我们配置的是负载均衡优先的建表策略，新建对照表如表3所示。可以看出，在新建对照表的第1份和第2份中存储“空”表项，在程序中这里存储的是0。新建对照表后，已经彻底没有了节点D的踪影了。

3份对照表
<table border="1" style="border-collapse:separate;color:#222222;font-family:tahoma, arial, 宋体, sans-serif;font-size:14px;width:400px;height:100px;">
<tbody>
<tr>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;0<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;1<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">2&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;3<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;4<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">0&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">1&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;2<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">3&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;4<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">0&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;1<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;2<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;3<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">4&nbsp;<br />
</span> 
</td>
</tr>
<tr>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;0<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;D<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;D<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;A<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;D<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;D<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;A<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;D<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;D<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;A<br />
</span> 
</td>
</tr>
<tr>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;1<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;D<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;D<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;D<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
</tr>
<tr>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;2<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;A<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;D<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;A<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;D<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;A<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">C&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;D</span> 
</td>
</tr>
</tbody>
</table>
表2 对照表
重建后的3份对照表
<table border="1" style="border-collapse:separate;color:#222222;font-family:tahoma, arial, 宋体, sans-serif;font-size:14px;width:400px;height:100px;">
<tbody>
<tr>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;0<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;1<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">2&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;3<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;4<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">0&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">1&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;2<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">3&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;4<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">0&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;1<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;2<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;3<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">4&nbsp;<br />
</span> 
</td>
</tr>
<tr>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;0<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;A<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;A<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;A<br />
</span> 
</td>
</tr>
<tr>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;1<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;"><br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<strong>A</strong><br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;A<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
</tr>
<tr>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;2<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;B<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;A<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<strong>B</strong><br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;A</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;"><strong>&nbsp;B</strong><br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;A<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;A<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">C&nbsp;<br />
</span> 
</td>
<td style="text-align:center;">
<span style="font-size:14px;">&nbsp;C<br />
</span> 
</td>
</tr>
</tbody>
</table>
根据对照表3，configserver如何发现那些节点需要迁移呢? 这个工作由groupinfo::fillmigratemachine函数来完成的。具体地，该函数通过对比对照表的mhashtable和dhashtable来判断那些节点有数据迁移任务。判断方法很直观，对比 mhashtable和dhashtable的存储slave bucket的表项。对于某一个bucket, 对比其slave bucket表项，在 mhashtable和dhashtable内容是否相同（顺序可不同），若存在差异，在该bucket需要迁移，并且master bucket所在机器负载迁移任务。configserver将这一信息记录起来。举例说明，第0个bucket(表3中加粗）, 在mhashtable中slave bucket项为{“空”，B}，而在dhashtable中的表项为{A,B}。显然{"空“,B}和{A,B}是不同的。因此，第0个bucket需要迁移，由节点C完成迁移工作。这里再多说点，若在mhash_table中的表项为{B,A}，那么，这个节点就不需要迁移了。为什么？想一想吧，很简单哦。fillmigratemachine主要是configserver从全局层面，统计需要迁移的bucket信息。
现在是该上代码的时候了，请看fill_migrate_machine的代码:
<pre><code>
int group_info::fill_migrate_machine()
{
  int migrate_count = 0;
  migrate_machine.clear();
  for(uint32_t i = 0; i &lt; server_table_manager.get_server_bucket_count();
      i++) {
    bool migrate_this_bucket = false;
    if(server_table_manager.m_hash_table[i] != 0) {
      if(server_table_manager.m_hash_table[i] !=
          server_table_manager.d_hash_table[i]) {
        migrate_this_bucket = true;
      }   
      else {
        for(uint32_t j = 1; j &lt; server_table_manager.get_copy_count();
            j++) {
          bool found = false;
          for(uint32_t k = 1; k &lt; server_table_manager.get_copy_count();
              k++) {
            if(server_table_manager.
                d_hash_table[j *
                server_table_manager.
                get_server_bucket_count() + i]
                == server_table_manager.m_hash_table[k *
                server_table_manager.
                get_server_bucket_count
                () + i]) {
              found = true;
              break;
            }
          }
          //找到了有内容不想他的表项
          if(found == false) {
            migrate_this_bucket = true;
            break;
          }
        }
      }
      if(migrate_this_bucket) {
        //记录要迁移的节点
        migrate_machine[server_table_manager.m_hash_table[i]]++;
        migrate_count++;
        log_info("added migrating machine: %s bucket %d ",
            tbsys::CNetUtil::addrToString(server_table_manager.
              m_hash_table[i]).c_str(),
            i);
      }
    }
  } 
</pre></code>

至此，configserver创建了对照表，并且记录了哪些存储节点有迁移任务。当某个节点完成迁移后，它就主动向configserver报告。这里没有采用configserver去轮训存储节点，应该是处于效率考虑的。
再次注意表2和表3，从全局上来看，节点D不可用后，需要迁移的Bucket编号为{0,1,2,3,4}。由于这个例子比较特殊，1个节点不可用后，会导致所有bucket均发生数据迁移。在线上环境中，通常bucket的数量要远远大于节点的数量。当一个存储节点不可用后，只会导致部分节点发生迁移，而不是所有节点发生迁移。

###2.6.3 存储节点完成迁移任务
从上一节中，我们知道configserver记录了哪些节点需完成bucket的迁移工作。那么，存储节点如何感知自己迁移哪些bucket，并将bucket迁移至何方呢？configserver没有直接告诉存储节点，而是告诉了存储节点当前bucket分布表，和迁移完成后的bucket分布表。那么，根据这2个分布表，存储节点完全知道自己需要迁移那个bucket,并且将bucket迁移至何处。新启动的线程，通过调用pthread_detach(pthread_self())来确保其父线程不会阻塞在更新对照表这个过程中。也就是说，在更新对照表的过程中，tair还是可以对我提供服务的。

####2.6.3.1 更新对照表
configserver创建好对照表后，通过心跳机制，将对照表分发给每一个存储节点。存储节点在收到对照表后，会对对照表的版本作检查。若检测到心跳信息中的对照表版本大于本地保存的对照表版本数（对照表版本数是依次递增的）， 会启动一个线程，更新对照表，并完成数据迁移工作。具体分析下存储节点更新对照表的代码，见代码注释。为了减少篇幅，我将略去部分不影响理解整体逻辑的部分代码。
<pre><code>void table_manager::do_update_table(uint64_t *new_table, size_t size, uint32_t table_version, uint32_t copy_count, uint32_t bucket_count)
{
  this-&gt;copy_count = copy_count;
  this-&gt;bucket_count = bucket_count;

  //新对照表 替换掉旧的对照表
  uint64_t *temp_table = new uint64_t[size];
  memcpy(temp_table, new_table, size * sizeof(uint64_t));

  tair::common::CScopedRwLock __scoped_lock(&amp;m_mutex,true);
  uint64_t *old_table = server_table;
  server_table = temp_table;
  if (old_table != NULL) {
    usleep(MISECONDS_ASSURANCE_TIME);
    delete [] old_table;
  }

  //available_server_idx记录新对照表中m_hash_table中记录的有效的节点。temp_holding_buckets， temp_holding_buckets记录了本存储节点存储的bucket的编号。
  //这里需要注意的是，cacluate_migrates函数将判断某个bucket是否需要被迁移；这里的策略是，对于某个bucket而言，只有该bucket的master bucket存储在本节点上，该节点才会去计算是否发生迁移。
  vector&lt;int&gt; temp_holding_buckets;
  for (size_t i=0; i&lt;get_hash_table_size(); i++) {
    available_server_ids.insert(new_table[i]);
    if (new_table[i] == local_server_ip::ip) {
      log_debug("take bucket: %d", (i%this-&gt;bucket_count));
      temp_holding_buckets.push_back(i % this-&gt;bucket_count);

      if (i &lt; this-&gt;bucket_count &amp;&amp; size &gt; get_hash_table_size()) {
        calculate_migrates(new_table, i);

      }
    }
  }
  //这里计算本节点在新的对照表中，负责的bucket情况
  if (size &gt; get_hash_table_size()) {
    // have migrate table
    for (size_t i=get_hash_table_size(); i&lt;2*get_hash_table_size(); i++) {
      available_server_ids.insert(new_table[i]);
      if (new_table[i] == local_server_ip::ip)
        padding_buckets.push_back(i % this-&gt;bucket_count);
    }
  }
  //这里通过对比该存储节点现在负责的bucket情况，和在新对照表中负责的bucket情况，计算出将要“释放”哪些bucket.
  calculate_release_bucket(temp_holding_buckets);
}</pre></code>
上述代码中，主要完成了对照表的新旧替换，完成了一些数据的统计，这些数据包括，本存储节点新增的bucket情况，不再存储的bucket情况，以及需要迁移的bucket情况。
2.6.3.2 收集需要迁移的bucket的信息
对照表更新后，很容易判断出那些bucket需要迁移, configserver记录了所有需要迁移的bucket信息。存储节点拿到对照表后，会分析出自己需要迁移的bucket编号，以及bucket迁移的目标节点。实际上，对于每一个bucket而言，都存在对应的节点存储其master bucket。只有master bucket所在的节点才会负责该bucket的是否进行迁移。 这个是合理的，因为读更新（写，删除）操作也是首先作用在master bucket所在节点上，然后在同步到slave bucket所在的节点。这个逻辑体现在do_update_tableh函数的第行处。

假设一个节点负责一个master bucket, 那么该节点如何确定该节点是否需要迁移，若迁移，迁移的目标节点时那里？ 原理比较直观。在m_hash_table中，有该bucket的master bucket和slave bucket所在的节点信息，以及该bucket在d_hash_table中所在的节点信息。结合表3， 例如第0号bucket在m_hash_table中的位置信息为T1={C, "空", B}, 在d_hash_table中的位置信息为：T2={C, A, B}。对于该bucket而言，对照表发生变化后，导致其master/slave bucket的存储节点位置发生了变化，需要迁移，并且迁移的地址目标节点为A。这里需要注意的是，程序检查bucket的对照表更新前后位置信息的时候，忽略其slave bucket存储位置在对照表中的次序关系。怎么理解? 例如，某bucket的2次位置信息T1={C,D,A}， T2={C, A, D}，这种情况下，是不会有数据迁移的。存储master bucket的节点会记录迁移信息<bucket_id, target_node>信息， 本来而言，节点C会记录这样信息：<0, A>。实现该逻辑的代码很简洁，请看代码：
<pre><code>
void table_manager::calculate_migrates(uint64_t *table, int index)
{  
  uint64_t* psource_table = table;
  uint64_t* pdest_table = table + get_hash_table_size();
  for (size_t i = 0; i &lt; this-&gt;copy_count; ++i) {

    bool need_migrate = true;
    uint64_t dest_dataserver = pdest_table[index + this-&gt;bucket_count * i];

    for (size_t j =0; j &lt; this-&gt;copy_count; ++j)     {    
      if (dest_dataserver == psource_table[index + this-&gt;bucket_count * j]) { 
        need_migrate = false; 
        break; 
      }     
    }    
    //记录迁移信息。
    if (need_migrate) {
      log_debug("add migrate item: bucket[%d] =&gt; %s", index, tbsys::CNetUtil::addrToString(dest_dataserver).c_str());
      migrates[index].push_back(dest_dataserver);
    }    
  }
  bucket_server_map_it it = migrates.find(index);
  if (it == migrates.end())
  {
    if (psource_table[index] != pdest_table[index])
    {    
      //this will add a empty vector to migrates,
      //some times only need to change master for a bucket
      migrates[index];
    }    
  }
}
</pre></code>
####2.6.3.3 数据迁移
在上一节中，对照表重建后，若发送数据迁移，负责master bucket的节点会知道将该bucket迁移至哪一个目标节点。有了这些信息后，该节点就会迁移数据。由于迁移数据的过程中，是不能停止对我服务的。这里就有个问题，某个bucket的数据正在迁移，若有读写请求怎么处理？ 对于，写，删除请求， 除外完成据请求外，还将日志记录在本地磁盘中。这些操作日志中记录了&lt;操作类型{PUT,REMOVE}, KEY, VALUE&gt;数据。在作为&lt;key,value&gt;的迁移后，还需要作为操作日志的迁移。目标节点收到迁移数据后，写入本地，收到操作日志后，回访日志，以保证数据一致性。

====================================

上午开发机挂了，无法干活儿，就继续我的代码分析工作。将之前写的内容重新整理，添加了部分新的内容。关于数据迁移部分，还有很多细节需要去理清。等理清后，补充完整。
