---
title: GNU build systems 之 autoconf
layout: post
tags: autoconf autoscan autotools make
category: programming
---

在很多开源 C/C++ 项目中都会遇到 configure 和 Makefile, 这些项目使用 GNU build system 管理.  
[GNU build system](http://en.wikipedia.org/wiki/GNU_build_system) 又称之为 Autotools, 它包含 [autoconf](http://en.wikipedia.org/wiki/Autoconf), [automake](http://en.wikipedia.org/wiki/Automake), [libtool](http://en.wikipedia.org/wiki/Libtool) 这三部分. [有一本书](http://book.douban.com/subject/3912140/)专门介绍这些工具集的使用, 这本书也有 [online html 版本](http://sourceware.org/autobook/autobook/autobook.html).

**我们為什麼需要使用 Autotools?**  
short answer: portability.  
摘抄自 wiki 上的一段话:  
>It can be difficult to make a software program portable: the C compiler differs from system to system; certain library functions are missing on some systems; header files may have different names. One way to handle this is write conditional code, with code blocks selected by means of preprocessor directives (#ifdef); but because of the wide variety of build environments this approach quickly becomes unmanageable. The GNU build system is designed to address this problem more manageably.

**开源项目如何做到更好的 portability?**  
常见的开源软件编译安装步骤:  
	$ ./configure -OPTIONS
	$ make
	\# make install
[configure 脚本](http://en.wikipedia.org/wiki/Configure_script_(computing))检查程序依赖的 libs 等.  
make 根据 Makefile 编译整个 project, 生成可执行文件.

**configure 脚本如何得来? Makefile 如何得来?**  
答案1: 手写.  
答案2: 利用工具生成, 手写最基础直白的规则, 并且表达方式是便于理解的.  
人们总是会选择答案2. GNU build system 就是答案2.

**图示**  
![alt GNU build system](http://upload.wikimedia.org/wikipedia/commons/8/84/Autoconf-automake-process.svg)

**如何得到 configure 脚本**  
autoconf 完成这部分工作.  
其中最基础的一步, 是根据预定义的一个 "checklist", 使用 autoscan 扫描 project 文件夹, 生成 GNU M4 格式的 configure.scan.  
这个 checklist 是 **/usr/share/autoconf/autoscan/autoscan.list**  
autoscan.list 是最重要的信息, 其内容大致为:  
>function: gethostname AC_CHECK_FUNCS  
>function: gethrtime AC_CHECK_FUNCS  
>function: getmntent AC_CHECK_FUNCS  
>function: getmntent AC_FUNC_GETMNTENT  
>function: getmntinfo AC_CHECK_FUNCS  
>function: getpagesize AC_CHECK_FUNCS  
>function: getpass AC_CHECK_FUNCS  
>function: getspnam AC_CHECK_FUNCS  
>function: **gettimeofday** AC_CHECK_FUNCS  
>function: getusershell AC_CHECK_FUNCS  
>function: getwd warn: getwd is deprecated, use getcwd instead  
>function: hasmntopt AC_CHECK_FUNCS  
>function: inet_ntoa AC_CHECK_FUNCS  

其中 gettimeofday 便是典型的会带来 portability 问题的函数了.

其他命令, 这里不再细述, 它们多是 perl 脚本或 shell 脚本:
	xan@xmachine:/usr/bin$ file auto*
	autoconf: POSIX shell script text executable
	autoconf2.64: POSIX shell script text executable
	autoheader: a /usr/bin/perl script text executable
	autoheader2.64: a /usr/bin/perl script text executable
	autoinst: symbolic link to '../share/texmf-texlive/scripts/fontools/autoinst'
	autom4te: a /usr/bin/perl -w script text executable
	autom4te2.64: a /usr/bin/perl -w script text executable
	automake: symbolic link to '/etc/alternatives/automake'
	automake-1.10: a /usr/bin/perl -w script text executable
	autoreconf: a /usr/bin/perl -w script text executable
	autoreconf2.64: a /usr/bin/perl -w script text executable
	autoscan: a /usr/bin/perl -w script text executable
	autoscan2.64: a /usr/bin/perl -w script text executable
	autoupdate: a /usr/bin/perl -w script text executable
	autoupdate2.64: a /usr/bin/perl -w script text executable

