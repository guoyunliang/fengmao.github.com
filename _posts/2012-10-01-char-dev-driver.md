---
title: 字符设备驱动
layout: post
category: linux
tags: device driver kernel
---

字符设备，char device；字符设备驱动，char device driver，cdriver。  
关于char dev driver如何实现，内核是如何表示、注册、开闭、读写字符设备的，ldd3 chapter3和很多网络资料都说得很清楚(如“[字符设备驱动再学习](http://edsionte.com/techblog/archives/2257)”)，这里我不再多说。  
这里说点其他的。  

硬盘是常见的块设备，而常见的字符设备有键盘、终端(以前没有图形界面的那种显示器)。这些都是物理设备，而虚拟的就更多了，虚拟终端就是常见的字符设备。  
字符设备和块设备的区别明显，块设备容量大，支持随机访问，它本身就用于存储(所以才支持随机访问吧)。字符设备只支持流式访问，其目的也不是存储，而是输入和显示吧。  

ldd3实现了一系列字符设备驱动，它们都是基于内存的伪设备。可以看到，写字符设备驱动，要遵循一定的规则。然后访问方法还是规约到file operations。  
这里引出两个实现上的细节问题：  
1. 字符设备对应的inode、file是关联在哪个文件系统里面的。我想应该是某个mem-fs。  
2. fops.read/write描述了如何读写字符设备，ldd3的例子是读写划归给scull的定长内存。  

第2点引起一个问题：字符设备到底有什么用？  
是这样的，对于键盘和终端这样实打实存在的设备，必须有对应的驱动。  
但是，伪字符设备有必要存在吗？  
因为，据我对configfs的初步了解，configfs支持十分类似的读写，我觉得用到伪字符设备的地方，可以用configfs替代了。我能找到伪字符设备存在的一个理由是：对它可以读写大量的数据，比如scull里面数据就是用链表管理的，每个节点包含一块数据区；而configfs只支持小量的数据访问，configfs没有专门针对“大数据”定义数据结构和函数逻辑。  
又立马想到procfs的seq_file，它支持显示大量数据，是否可以用procfs文件完全替代伪字符设备？  
应该是不可以的，因为从目的上来看，procfs的目的是显示内核数据，我没有看到procfs专门针对“写入”，尤其是大量写入做出支持。  

这就是我“怯怯地”对伪字符设备的理解。
