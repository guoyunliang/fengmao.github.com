---
title: 【Tair源代码分析<1>】
layout: post
category: tair
tags: memory kernel
---
##写在最前面
我加入TAIR组后，曾试图写TAIR源码分析。后来，有新任务了，就把这个事情放下了。现在，随着工作的进展，我觉得非常有必要继续这个任务。于是，有了以下博文。这些博文，或许写的不准确，但是，我会一致维护下去，完善之。 欢迎大家拍砖，有砖尽管扔。本文，最初写在CSDN，后又移到OSCHINA。link: http://my.oschina.net/tfengmao/blog/111399

##概述 
Tair是分布式、高性能、可扩展、搞可靠性的存储系统。目前，Tair已成为开源项目，代码在：http://code.taobao.org/p/tair/src/.关于Tair的更多介绍，见http://code.taobao.org/p/tair/wiki/index/。

##1. 代码结构
简要介绍Tair的代码结构，如下所示：
<pre><code>.
   |-- AUTHORS
   |-- COPYING
   |-- ChangeLog
   |-- Makefile.am
   |-- NEWS
   |-- README
   |-- bootstrap.sh
   |-- configure.ac
   |-- contrib
   |-- doc
   |-- packages
   |-- rpm 
   |-- scripts
   |-- share
   |-- src 
   |   |-- Makefile.am
   |   |-- client
   |   |-- common
   |   |-- configserver
   |   |-- dataserver
   |   |-- invalserver
   |   |-- packets
   |   |-- plugin
   |   |-- statserver
   |   |   |-- Makefile.am
   |   |   |-- include
   |   |   `-- storage
   |   |-- storage
   |   |   |-- fdb
   |   |   |-- kdb
   |   |   |-- ldb
   |   |   |-- mdb
   |   |   `-- storage_manager.hpp
   |   `-- tools
   |-- tcmalloc.m4
    `-- test
   </pre></code>
整个系统的主要代码集中在src目录下。在该目录下，client目录中包含了c++客户端的所有代码，应用通过该客户端访问Tair系统；commmon目录中包含了一些工具函数或者共用的C++类的实现；configserver中包含了配置服务实现的代码；dataserver中包含了数据服务器的代码实现；invalserver目录中包含了失效服务器的实现代码；storage目录中包含了Tair底层所使用的存储引擎,目前Tair主要使用2中存储引擎——mdb，leveldb; tools目录中包含了部分系统运维工具；test目录中包含了测试文件。

Tair系统还依赖底层网络编程库——tbnet,tbsys.这两个底层库提供了网络通信，配置文件管理，等基础功能；这里就不一一介绍了。
##2.配置服务器
###2.1 main
配置服务器（下文称为configserver)是tair系统的中心节点。该节点提供全局信息管理功能，通过主备机制实现中心节点的高可用性。在Tair系统中，configserver提供了哪些功能呢？configserver具有对对照表（server table)的管理，维护主备配置服务器之间的心跳，维护配置服务器与数据服务器之间的心跳，对数据迁移的管理，以及其他的全局信息管理。下文以这些功能为线索，进行代码分析。
接下来就先分析该服务器的main函数吧，代码如下：
<pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  1: <span style="color: #0000ff">int</span> main(<span style="color: #0000ff">int</span> argc, <span style="color: #0000ff">char</span> *argv[])
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  2:   {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  3:     <span style="color: #0000ff">char</span> *config_file = parse_cmd_line(argc, argv);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  4:     <span style="color: #0000ff">if</span>(TBSYS_CONFIG.load(config_file)) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  5:       <span style="color: #0000ff">return</span> EXIT_FAILURE;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  6:     }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  7:     <span style="color: #0000ff">if</span>(!tbsys::CFileUtil::mkdirs(dir_path)) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  8:      <span style="color: #0000ff">return</span> EXIT_FAILURE;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  9:    }   
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 10:    <span style="color: #0000ff">if</span>(tbsys::CProcess::startDaemon(sz_pid_file, sz_log_file) == 0) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 11:      tair_cfg_svr = <span style="color: #0000ff">new</span> tair::config_server::tair_config_server();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 12:      tair_cfg_svr-&gt;start();     
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 13:      <span style="color: #0000ff">delete</span> tair_cfg_svr;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 14:    } 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 15:   <span style="color: #0000ff">return</span> EXIT_SUCCESS;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 16:   }</pre></pre>
为了方便分析，上述代码经过精简的。可以看出，main函数在加载配置文件内容到内存，创建工作目录，将本线程设置为后台线程。接着，创建tair::config_server对象，调用start函数，configserver就在完成初始化后，就开始对外提供服务了。
###2.2 configserver初始化
configserver的初始化工作主要有start中完成的。该函数首先启动线程池，该线程池用于处理各种请求；打开2个TCP端口，一个用于处理对外提供服务，另外一个用于主备configserver之间的心跳；再开一个称为my_server_conf_thread的线程。接下来，看看该线程的初始化所在的事情：
<pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  1: <span style="color: #0000ff">void</span> tair_config_server::start()
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  2: {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  3:   <span style="color: #0000ff">if</span>(initialize()) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  4:     <span style="color: #0000ff">return</span>;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  5:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  6: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  7:   task_queue_thread.start();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  8: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  9: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 10:   <span style="color: #0000ff">if</span>(heartbeat_transport.listen(spec, &amp;packet_streamer, <span style="color: #0000ff">this</span>) == NULL) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 11:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 12: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 13: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 14:   <span style="color: #0000ff">if</span>(packet_transport.listen(spec, &amp;packet_streamer, <span style="color: #0000ff">this</span>) == NULL) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 15:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 16: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 17: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 18:   packet_transport.start();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 19:   heartbeat_transport.start();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 20:   my_server_conf_thread.start();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 21: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 22: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 23:   task_queue_thread.wait();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 24:   my_server_conf_thread.wait();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 25:   packet_transport.wait();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 26:   heartbeat_transport.wait();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 27: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 28: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 29:   destroy();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 30: }</pre></pre>
task_queue_thread.start,在没有请求请求来的情况下，就会等待；packet_transport, heartbeat_transport.start后，将接受到的请求，放入到线程池队列中，工作线程处理请求。这里主要分析my_server_conf_thread线程。该线程的run函数做如下工作：
1)读取配置文件，建立保存group信息的数据结构，这些信息包括该group的数据服务器列表等；
2)如果主配置服务器存在并且alive,备配置服务器从主配置服务器上读取group的配置信息，而不是从配置文件中读取; 
3)建立循环，循环做如下事情：
a)检查group的配置文件版本信息，确定是否要重新读取配置文件；
b)检查group的对照表，确定是否要重新建立对照表，若需重建，设置重建标志；
c)检查配置服务器的状态；
d)检查数group的数据服务器的状态；
贴上该线程的run函数的主要代码，代码中添加了注释，以便理解：
<pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  1: <span style="color: #0000ff">void</span> server_conf_thread::run(tbsys::CThread * thread, <span style="color: #0000ff">void</span> *arg)
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  2: {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  3:   <span style="color: #008000">//根据配置文件中配置的主备CS的IP和本机的IP，来确定当前cs是作为主配置服务器，还是作为备配置服务器；</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  4:   uint64_t sync_config_server_id = 0;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  5:   uint64_t tmp_master_config_server_id = master_config_server_id;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  6:   <span style="color: #0000ff">if</span>(tmp_master_config_server_id == util::local_server_ip::ip) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  7:     tmp_master_config_server_id = get_slave_server_id();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  8:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  9:   <span style="color: #0000ff">if</span>(tmp_master_config_server_id)
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 10:   <span style="color: #008000">//作为备配置服务器在运行</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 11:   sync_config_server_id =
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 12:     get_master_config_server(tmp_master_config_server_id, 1); 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 13:   <span style="color: #0000ff">if</span>(sync_config_server_id) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 14:     log_info(&quot;<span style="color: #8b0000">syncConfigServer: %s</span>&quot;,
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 15:         tbsys::CNetUtil::addrToString(sync_config_server_id).
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 16:         c_str());
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 17:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 18:   <span style="color: #008000">// 读取group的配置文件名称，这里需要注意的是，在同一个Group中可以配置多个group;</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 19:   <span style="color: #0000ff">const</span> <span style="color: #0000ff">char</span> *group_file_name =
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 20:     TBSYS_CONFIG.getString(CONFSERVER_SECTION, TAIR_GROUP_FILE, NULL);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 21:   <span style="color: #0000ff">if</span>(group_file_name == NULL) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 22:     log_error(&quot;<span style="color: #8b0000">not found %s:%s </span>&quot;, CONFSERVER_SECTION, TAIR_GROUP_FILE);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 23:     <span style="color: #0000ff">return</span>;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 24:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 25:   <span style="color: #008000">//将group的配置文件的最后修改时间作为该文件的版本号；</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 26:   uint32_t config_version_from_file = get_file_time(group_file_name);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 27:   <span style="color: #008000">//bool rebuild_group = true;</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 28:   <span style="color: #0000ff">bool</span> rebuild_this_group = <span style="color: #0000ff">false</span>;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 29:   <span style="color: #008000">// 这里读取配置文件。对于备配置服务器而言，它需要从主配置服务器中读取配置文件，如果主配置服务器是alive的话；</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 30:   load_group_file(group_file_name, config_version_from_file,
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 31:       sync_config_server_id);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 32:   <span style="color: #008000">//if (syncConfigServer != 0) {</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 33:   <span style="color: #008000">//    rebuild_group = false;</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 34:   <span style="color: #008000">//} </span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 35:   <span style="color: #008000">//当当前机器运行的cs是主配置服务器，或者主配置服务器down掉时，运行以下代码</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 36:   <span style="color: #008000">//set myself is master</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 37:   <span style="color: #0000ff">if</span>(config_server_info_list.size() == 2U &amp;&amp;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 38:       (config_server_info_list[0]-&gt;server_id == util::local_server_ip::ip
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 39:        || (sync_config_server_id == 0
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 40:          &amp;&amp; config_server_info_list[1]-&gt;server_id ==
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 41:          util::local_server_ip::ip))) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 42:     <span style="color: #008000">//running as a master, or not find the master , only the slave.</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 43:     master_config_server_id = util::local_server_ip::ip;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 44:     log_info(&quot;<span style="color: #8b0000">set MASTER_CONFIG: %s</span>&quot;,
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 45:         tbsys::CNetUtil::addrToString(master_config_server_id).
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 46:         c_str());
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 47:     {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 48:       <span style="color: #008000">//group info map数据结构在读取配置文件时候建立，具体在load_group_file中完成</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 49:       group_info_map::iterator it;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 50:       group_info_rw_locker.rdlock();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 51:       <span style="color: #0000ff">for</span>(it = group_info_map_data.begin();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 52:           it != group_info_map_data.end(); ++it) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 53:         <span style="color: #0000ff">if</span>(rebuild_this_group) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 54:           it-&gt;second-&gt;set_force_rebuild();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 55:         }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 56:         <span style="color: #0000ff">else</span> {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 57:           <span style="color: #008000">//通过检查对照表中是否存在0的项，来确定是否需要重建对照表。对照表的建立是以group为单位的，各个group维护自己的对照表；</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 58:           <span style="color: #0000ff">bool</span> need_build_it = <span style="color: #0000ff">false</span>;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 59:           <span style="color: #0000ff">const</span> uint64_t *p_table = it-&gt;second-&gt;get_hash_table();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 60:           log_debug(&quot;<span style="color: #8b0000">server_bucket_count: %d</span>&quot;, it-&gt;second-&gt;get_server_bucket_count());
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 61:           <span style="color: #0000ff">for</span>(uint32_t i = 0; i &lt; it-&gt;second-&gt;get_server_bucket_count();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 62:               ++i) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 63:             <span style="color: #0000ff">if</span>(p_table[i] == 0) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 64:               need_build_it = <span style="color: #0000ff">true</span>;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 65:               <span style="color: #0000ff">break</span>;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 66:             }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 67:           }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 68:           <span style="color: #0000ff">if</span>(need_build_it) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 69:             <span style="color: #008000">//这里将标记置为1，表示该Group的对照表需要重建</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 70:             it-&gt;second-&gt;set_force_rebuild();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 71:           }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 72:           <span style="color: #0000ff">else</span> {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 73:             it-&gt;second-&gt;set_table_builded();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 74:           }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 75:         }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 76:       }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 77:       group_info_rw_locker.unlock();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 78:     }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 79:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 80:   <span style="color: #008000">// will start loop</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 81:   uint32_t loop_count = 0;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 82:   tzset();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 83:   <span style="color: #0000ff">int</span> log_rotate_time = (time(NULL) - timezone) % 86400;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 84:   <span style="color: #0000ff">struct</span> timespec tm;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 85:   clock_gettime(CLOCK_MONOTONIC, &amp;tm);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 86:   <span style="color: #008000">//记录心跳时间</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 87:   heartbeat_curr_time = tm.tv_sec;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 88:   is_ready = <span style="color: #0000ff">true</span>;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 89:   <span style="color: #008000">//开始loop</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 90:   <span style="color: #0000ff">while</span>(!_stop) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 91:     <span style="color: #0000ff">struct</span> timespec tm;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 92:     clock_gettime(CLOCK_MONOTONIC, &amp;tm);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 93:     heartbeat_curr_time = tm.tv_sec;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 94:     <span style="color: #008000">//检查另外一个cs是否down掉</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 95:     <span style="color: #0000ff">for</span>(size_t i = 0; i &lt; config_server_info_list.size(); i++) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 96:       server_info *server_info_it = config_server_info_list[i];
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 97:       <span style="color: #0000ff">if</span>(server_info_it-&gt;server_id == util::local_server_ip::ip)
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 98:         <span style="color: #0000ff">continue</span>;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 99:       <span style="color: #0000ff">if</span>(server_info_it-&gt;status != server_info::ALIVE
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">100:           &amp;&amp; (loop_count % 30) != 0) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">101:         down_slave_config_server = server_info_it-&gt;server_id;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">102:         log_debug(&quot;<span style="color: #8b0000">local server: %s set down slave config server: %s</span>&quot;,
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">103:             tbsys::CNetUtil::addrToString(util::local_server_ip::ip).c_str(),
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">104:             tbsys::CNetUtil::addrToString(down_slave_config_server).c_str());
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">105:         <span style="color: #0000ff">continue</span>;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">106:       }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">107:       <span style="color: #008000">//向另外一个cs发送心跳包</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">108:       down_slave_config_server = 0;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">109:       request_conf_heartbeart *new_packet = <span style="color: #0000ff">new</span> request_conf_heartbeart();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">110:       new_packet-&gt;server_id = util::local_server_ip::ip;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">111:       new_packet-&gt;loop_count = loop_count;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">112:       <span style="color: #0000ff">if</span>(connmgr_heartbeat-&gt;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">113:           sendPacket(server_info_it-&gt;server_id, new_packet) == <span style="color: #0000ff">false</span>) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">114:         <span style="color: #0000ff">delete</span> new_packet;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">115:       }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">116:     }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">117: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">118: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">119:     loop_count++;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">120:     <span style="color: #0000ff">if</span>(loop_count &lt;= 0)
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">121:       loop_count = TAIR_SERVER_DOWNTIME + 1;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">122:     <span style="color: #008000">//读取配置文件的版本信息，检查是否需要重新读取配置文件，每次修改配置文件，总会触发CS重新读取配置文件</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">123:     uint32_t curver = get_file_time(group_file_name);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">124:     <span style="color: #0000ff">if</span>(curver &gt; config_version_from_file) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">125:       log_info(&quot;<span style="color: #8b0000">groupFile: %s, curver:%d configVersion:%d</span>&quot;,
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">126:           group_file_name, curver, config_version_from_file);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">127:       <span style="color: #008000">//read config from file</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">128:       <span style="color: #008000">//读取配置文件，第3个参数为0，表示此次只从配置文件读取，不从另外一个CS上读取配置文件</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">129:       load_group_file(group_file_name, curver, 0);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">130:       config_version_from_file = curver;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">131:       <span style="color: #008000">//作为主CS，将新的配置文件发送到备CS</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">132:       send_group_file_packet();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">133:     }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">134:     <span style="color: #008000">//检查配置服务器状态</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">135:     check_config_server_status(loop_count);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">136:     <span style="color: #008000">//检查数据服务器状态</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">137:     <span style="color: #0000ff">if</span>(loop_count &gt; TAIR_SERVER_DOWNTIME) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">138:       check_server_status(loop_count);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">139:     }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">140: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">141: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">142:     <span style="color: #008000">// 日志回滚</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">143:     log_rotate_time++;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">144:     <span style="color: #0000ff">if</span>(log_rotate_time % 86400 == 86340) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">145:       log_info(&quot;<span style="color: #8b0000">rotateLog End</span>&quot;);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">146:       TBSYS_LOGGER.rotateLog(NULL, &quot;<span style="color: #8b0000">%d</span>&quot;);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">147:       log_info(&quot;<span style="color: #8b0000">rotateLog start</span>&quot;);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">148:     }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">149:     <span style="color: #0000ff">if</span>(log_rotate_time % 3600 == 3000) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">150:       log_rotate_time = (time(NULL) - timezone) % 86400;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">151:     }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">152:     <span style="color: #008000">//休息1s</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">153:     TAIR_SLEEP(_stop, 1);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">154:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">155:   is_ready = <span style="color: #0000ff">false</span>;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">156: }</pre></pre>
接下来分析load_group_file函数，该函数主要功能是获取配置文件，当配置文件版本号发生变化后，就会调用该函数，获取最新的配置信息；上代码，在代码中添加注释：
<pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  1: <span style="color: #0000ff">void</span> server_conf_thread::load_group_file(<span style="color: #0000ff">const</span> <span style="color: #0000ff">char</span> *file_name,
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  2:                                              uint32_t version,
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  3:                                              uint64_t sync_config_server_id)
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  4: {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  5:   <span style="color: #0000ff">if</span>(file_name == NULL)
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  6:     <span style="color: #0000ff">return</span>;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  7:   tbsys::CConfig config;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  8:   <span style="color: #0000ff">if</span>(config.load((<span style="color: #0000ff">char</span> *) file_name) == EXIT_FAILURE) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  9:     log_error(&quot;<span style="color: #8b0000">load config file %s error</span>&quot;, file_name);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 10:     <span style="color: #0000ff">return</span>;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 11:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 12: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 13: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 14:   log_info(&quot;<span style="color: #8b0000">begin load group file, filename: %s, version: %d</span>&quot;, file_name,
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 15:       version);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 16:   <span style="color: #008000">//这里获取所有group的名称</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 17:   vector&lt;<span style="color: #0000ff">string</span>&gt; section_list;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 18:   config.getSectionName(section_list);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 19:   <span style="color: #008000">// start up, get hash table from an other config server if exist one.</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 20:   <span style="color: #008000">//若sync_config_server_id不为0， 则表示从sync_config_server_id对应的CS上获取配置信息</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 21:   <span style="color: #008000">//若从另外一个CS上配置服务器上获取到了GROUP的配置信息后，就不再读取本地配置文件了</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 22:   <span style="color: #0000ff">if</span>(sync_config_server_id
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 23:       &amp;&amp; sync_config_server_id != util::local_server_ip::ip) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 24:     get_server_table(sync_config_server_id, NULL, GROUP_CONF);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 25:     <span style="color: #0000ff">for</span>(size_t i = 0; i &lt; section_list.size(); i++) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 26:       get_server_table(sync_config_server_id,
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 27:           (<span style="color: #0000ff">char</span> *) section_list[i].c_str(), GROUP_DATA);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 28:     }   
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 29:     <span style="color: #008000">// here we need reload group configfile, since the file has been synced</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 30:     <span style="color: #0000ff">if</span>(config.load((<span style="color: #0000ff">char</span> *) file_name) == EXIT_FAILURE) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 31:       log_error(&quot;<span style="color: #8b0000">reload config file error: %s</span>&quot;, file_name);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 32:       <span style="color: #0000ff">return</span>;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 33:     }   
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 34:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 35: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 36: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 37:   set&lt;uint64_t&gt; server_id_list;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 38:   group_info_rw_locker.wrlock();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 39:   server_info_rw_locker.wrlock();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 40:   <span style="color: #0000ff">for</span>(size_t i = 0; i &lt; section_list.size(); i++) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 41:     group_info_map::iterator it =
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 42:       group_info_map_data.find(section_list[i].c_str());
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 43:     group_info *group_info_tmp = NULL;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 44:     <span style="color: #0000ff">if</span>(it == group_info_map_data.end()) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 45:       <span style="color: #008000">//根据每一个group name来创建group_info数据结构，该数据结构包含了一个group所需的</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 46:       group_info_tmp =
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 47:         <span style="color: #0000ff">new</span> group_info((<span style="color: #0000ff">char</span> *) section_list[i].c_str(),
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 48:             &amp;data_server_info_map, connmgr);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 49:       group_info_map_data[group_info_tmp-&gt;get_group_name()] =
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 50:         group_info_tmp;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 51:     }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 52:     <span style="color: #0000ff">else</span> {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 53:       grjup_info_tmp = it-&gt;second;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 54:     }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 55:     <span style="color: #008000">//group加载自身配置信息</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 56:     group_info_tmp-&gt;load_config(config, version, server_id_list);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 57:     <span style="color: #008000">//获取有效的数据服务器</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 58:     group_info_tmp-&gt;find_available_server();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 59:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 60:   <span style="color: #008000">//由于配置文件变动，可能导致数据服务器列表中的内容也发生变化。若发送变化，就需要去掉过时的数据服务器信息</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 61:   set &lt;uint64_t&gt; map_id_list;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 62:   set &lt;uint64_t&gt; should_del_id_list;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 63:   server_info_map::iterator sit;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 64:   <span style="color: #0000ff">for</span>(sit = data_server_info_map.begin();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 65:       sit != data_server_info_map.end(); ++sit) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 66:     map_id_list.insert(sit-&gt;second-&gt;server_id);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 67:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 68:   std::set_difference(map_id_list.begin(), map_id_list.end(),
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 69:       server_id_list.begin(), server_id_list.end(),
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 70:       inserter(should_del_id_list,
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 71:         should_del_id_list.begin()));
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 72:   <span style="color: #0000ff">for</span>(set&lt;uint64_t&gt;::iterator it = should_del_id_list.begin();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 73:       it != should_del_id_list.end(); ++it) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 74:     sit = data_server_info_map.find(*it);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 75:     <span style="color: #0000ff">if</span>(sit != data_server_info_map.end()) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 76:       sit-&gt;second-&gt;server_id = 0;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 77:       data_server_info_map.erase(sit);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 78:     }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 79:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 80:   <span style="color: #0000ff">for</span>(group_info_map::iterator it = group_info_map_data.begin();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 81:       it != group_info_map_data.end(); ++it) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 82:     it-&gt;second-&gt;correct_server_info(sync_config_server_id
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 83:         &amp;&amp; sync_config_server_id !=
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 84:         util::local_server_ip::ip);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 85:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 86:   log_info(&quot;<span style="color: #8b0000">machine count: %d, group count: %d</span>&quot;,
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 87:       data_server_info_map.size(), group_info_map_data.size());
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 88:   server_info_rw_locker.unlock();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 89:   group_info_rw_locker.unlock();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 90: }</pre></pre>
在my_server_conf_thread的run函数中，若作为master运行的时候，检测到配置文件发生变化后，调用load_group_file来读取最新配置文件。在获取新的配置内容后，调用 send_group_file_packet函数将新的配置文件发送到slave上。因此在修改一个集群的配置文件时候，只需修改master的配置文件，修改后的内容会自动同步到slave服务器上。
 
###2.3 配置服务器状态检查
在my_server_conf_thread的run函数中，周期性检查配置服务器和数据服务器的状态，若状态发生变化，则做相应处理。若作为主配置服务器运行，该函数检查备配置服务器的状态，能检查到2种状态变化：
1） 备配置服务器down掉，不需发送主备配置服务器切换；
2）  备配置服务器up了，此时也不需要发生主备配置服务器切换；在这种情况下， 备份配置服务器需要和主配置服务同步数据； 
若作为备配置服务器运行，则该函数将检查主配置服务器的状态，能检查到2种状态变化： 	
1）主配置服务器down了，发生主备配置服务器切换；
2）主配置服务器up，也发生主备配置服务器切换；若发生切换，作为主配置服务器运行的代码，会重新读取配配置文件；
检查配置服务器状态的代码以及注释如下：
<pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em">  1: <span style="color:#0000FF">void</span> server_conf_thread::check_config_server_status(uint32_t loop_count)
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em">  2: {
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em">  3:   <span style="color:#008000">//若只有一个配置服务器，则该函数无需做更多功能</span>
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em">  4:   <span style="color:#0000FF">if</span>(config_server_info_list.size() != 2U) {
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em">  5:     <span style="color:#0000FF">return</span>;
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em">  6:   }
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em">  7:   <span style="color:#0000FF">bool</span> master_status_changed = <span style="color:#0000FF">false</span>;
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em">  8:   <span style="color:#008000">//每一个配置服务器记录其上一次收到对方心跳包的时机，根据这个时间，和一个全局的心跳时间，来检测另外一个配置服务器的状态</span>
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em">  9:   uint32_t now = heartbeat_curr_time - TAIR_SERVER_DOWNTIME * 2;
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 10:   <span style="color:#0000FF">bool</span> config_server_up = <span style="color:#0000FF">false</span>;
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 11:   <span style="color:#0000FF">for</span>(size_t i = 0; i &lt; config_server_info_list.size(); i++) {
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 12:     server_info *server_info_tmp = config_server_info_list[i];
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 13:     <span style="color:#008000">//只检查另外一个配置服务器</span>
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 14:     <span style="color:#0000FF">if</span>(server_info_tmp-&gt;server_id == util::local_server_ip::ip) {        <span style="color:#008000">// this is myself</span>
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 15:       <span style="color:#0000FF">continue</span>;
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 16:     }   
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 17:     <span style="color:#008000">//如果超过TAIR_SERVER_DOWNTIME * 2时间内没有收到另外一个配置服务器的心跳包，该配置服务器如果其记录状态为alive，再次通过发送一个请求包到对端服务器，若对端服务器没有返回，则认为对端的配置服务器已经down了；</span>
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 18:     <span style="color:#0000FF">if</span>(server_info_tmp-&gt;last_time &lt; now &amp;&amp; server_info_tmp-&gt;status == server_info::ALIVE) {        <span style="color:#008000">// downhost</span>
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 19:       <span style="color:#0000FF">if</span>(tbnet::ConnectionManager::isAlive(server_info_tmp-&gt;server_id) ==
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 20:           <span style="color:#0000FF">true</span>)
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 21:         <span style="color:#0000FF">continue</span>;
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 22:       server_info_tmp-&gt;status = server_info::DOWN;
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 23:       <span style="color:#008000">//若down掉的配置服务器，在配置文件中配置的为主配置服务器，则表示需要切换主配置服务器了</span>
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 24:       <span style="color:#0000FF">if</span>(i == 0)
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 25:         master_status_changed = <span style="color:#0000FF">true</span>;
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 26:       log_warn(&quot;<span style="color:#8B0000">CONFIG HOST DOWN: %s</span>&quot;,
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 27:           tbsys::CNetUtil::addrToString(server_info_tmp-&gt;server_id).
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 28:           c_str());
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 29:     }   
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 30:     <span style="color:#008000">//若在TAIR_SERVER_DOWNTIME * 2内收到了对端配置服务器的心跳包，并且当前记录状态为down，则修改其为alive。这表示另外一个配置服务器已经活过来了（或许是人工重新启动的）</span>
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 31:     <span style="color:#0000FF">else</span> <span style="color:#0000FF">if</span>(server_info_tmp-&gt;last_time &gt; now &amp;&amp; server_info_tmp-&gt;status == server_info::DOWN) {        <span style="color:#008000">// uphost</span>
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 32:       server_info_tmp-&gt;status = server_info::ALIVE;
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 33:       <span style="color:#0000FF">if</span>(i == 0)
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 34:         master_status_changed = <span style="color:#0000FF">true</span>;
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 35:       config_server_up = <span style="color:#0000FF">true</span>;
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 36:       log_warn(&quot;<span style="color:#8B0000">CONFIG HOST UP: %s</span>&quot;,
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 37:           tbsys::CNetUtil::addrToString(server_info_tmp-&gt;server_id).
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 38:           c_str());
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 39:     }   
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 40:   }
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 41:   <span style="color:#008000">// 没有发生主配置服务器切换，并且备配置服务器起来了，需要将所有group的client version 和 server version都增加一个常量（这里是10）</span>
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 42:   <span style="color:#0000FF">if</span>(master_status_changed == <span style="color:#0000FF">false</span>) {
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 43:     <span style="color:#0000FF">if</span>(config_server_up
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 44:         &amp;&amp; master_config_server_id == util::local_server_ip::ip) {
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 45:       uint64_t slave_id = get_slave_server_id();
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 46:       group_info_map::iterator it; 
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 47:       group_info_rw_locker.rdlock();
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 48:       <span style="color:#0000FF">for</span>(it = group_info_map_data.begin();
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 49:           it != group_info_map_data.end(); ++it) {
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 50:         <span style="color:#008000">// for we can't get peer's version from protocol, add 10 to client version and server</span>
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 51:         it-&gt;second-&gt;inc_version(server_up_inc_step);
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 52:         it-&gt;second-&gt;send_server_table_packet(slave_id);
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 53:         log_warn(&quot;<span style="color:#8B0000">config server up and master not changed, version changed. </span>&quot;
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 54:             &quot;<span style="color:#8B0000">group name: %s, client version: %u, server version: %u</span>&quot;,
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 55:             it-&gt;second-&gt;get_group_name(), it-&gt;second-&gt;get_client_version(), it-&gt;second-&gt;get_server_version());
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 56:       }
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 57:       group_info_rw_locker.unlock();
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 58:     }
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 59:     <span style="color:#008000">//若没有发生主 备切换，这里将返回，这里需要注意的。</span>
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 60:     <span style="color:#0000FF">return</span>;
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 61:   }
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 62:   <span style="color:#008000">//代码执行到这里，表示发生主备切换</span>
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 63:   server_info *server_info_master = config_server_info_list[0];
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 64:   <span style="color:#0000FF">if</span>(server_info_master-&gt;status == server_info::ALIVE) {
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 65:     master_config_server_id = server_info_master-&gt;server_id;
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 66:   }
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 67:   <span style="color:#0000FF">else</span> {
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 68:     master_config_server_id = util::local_server_ip::ip;
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 69:   }
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 70:   <span style="color:#0000FF">if</span>(master_config_server_id == util::local_server_ip::ip) {
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 71:     
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 72:     <span style="color:#008000">//只有作为master的配置服务器才会执行下面代码,从本地配置文件中读取配置信息。这里为啥不将配置文件信息同步到备配置服务器上呢？</span>
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 73:     <span style="color:#0000FF">const</span> <span style="color:#0000FF">char</span> *group_file_name =
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 74:       TBSYS_CONFIG.getString(CONFSERVER_SECTION, TAIR_GROUP_FILE, NULL);
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 75:     <span style="color:#0000FF">if</span>(group_file_name == NULL) {
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 76:       log_error(&quot;<span style="color:#8B0000">not found %s:%s </span>&quot;, CONFSERVER_SECTION, TAIR_GROUP_FILE);
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 77:       <span style="color:#0000FF">return</span>;
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 78:     }
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 79: 
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 80: 
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 81:     uint32_t curr_version = get_file_time(group_file_name);
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 82:     load_group_file(group_file_name, curr_version, 0);
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 83:   }
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 84:   log_warn(&quot;<span style="color:#8B0000">MASTER_CONFIG changed %s</span>&quot;,
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 85:       tbsys::CNetUtil::addrToString(master_config_server_id).
</pre><pre style="background-color: #FFFFFF; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 86:       c_str());
</pre><pre style="background-color: #C0C0C0; font-family: consolas,'Courier New',courier,monospace; font-size: 13px; width: 100%; margin: 0em"> 87: }</pre></pre>
###2.4检查数据服务器状态
函数check_server_status函数完成数据服务器状态检查工作。check_server_status函数在server_conf_thread的run函数中被调用，周期性运行。其主要作以下工作：
1）标记出group_info发生变化了的group。configserver可以管理多个group, group的全局信息都保存在group_info数据结构中。
2）检查dataserver的状态；对于dataserver恢复运行后，根据配置策略不同而做不同处理；无论是检查到dataserver恢复或者挂掉，都需要重建对照表的。
3）检查数据迁移工作；在对照表建立后，configserver会判断出那些机器需要作数据迁移。数据迁移完成后，执行数据迁移的dataserver会向configserver报告数据迁移已完成，从而修改状态信息。
<pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  1: <span style="color: #0000ff">void</span> server_conf_thread::check_server_status(uint32_t loop_count)
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  2: {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  3:   set&lt;group_info *&gt;change_group_info_list;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  4:   <span style="color: #008000">//收集需要重新建立对照表的group，在调用该函数之前，在检查配置服务器状态的函数过程中，还有在初始化的时候，group_info_map被首次填，有可能改变group_info_map数据结构；</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  5:   <span style="color: #008000">//当group的配置信息发生变化后，重建对照表标志就会被置位；</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  6:   group_info_map::iterator it; 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  7:   <span style="color: #0000ff">for</span>(it = group_info_map_data.begin(); it != group_info_map_data.end();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">  8:       ++it) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">  9:     <span style="color: #0000ff">if</span>(it-&gt;second-&gt;is_need_rebuild()) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 10:       change_group_info_list.insert(it-&gt;second);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 11:     }   
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 12:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 13: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 14: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 15:   server_info_map::iterator sit;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 16:   <span style="color: #0000ff">for</span>(sit = data_server_info_map.begin();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 17:       sit != data_server_info_map.end(); ++sit) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 18:     <span style="color: #008000">//a bad one is alive again, we do not mark it ok unless some one tould us to. </span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 19:     <span style="color: #008000">//administrator can touch group.conf to let these data serve alive again.</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 20:     uint32_t now;                <span style="color: #008000">// this decide how many seconds since last heart beat, we will mark this data server as a bad one.</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 21:     <span style="color: #0000ff">if</span>(sit-&gt;second-&gt;group_info_data) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 22:       now =
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 23:         heartbeat_curr_time -
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 24:         sit-&gt;second-&gt;group_info_data-&gt;get_server_down_time();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 25:     }   
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 26:     <span style="color: #0000ff">else</span> {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 27:       now = heartbeat_curr_time - TAIR_SERVER_DOWNTIME;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 28:     }   
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 29:     <span style="color: #0000ff">if</span>(sit-&gt;second-&gt;status != server_info::DOWN) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 30:     <span style="color: #008000">//dataserver down了，也是通过上一次收到其心跳包的时间来判断的；</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 31:       <span style="color: #0000ff">if</span>((sit-&gt;second-&gt;last_time &lt; now 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 32:             &amp;&amp; (sit-&gt;second-&gt;status == server_info::ALIVE
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 33:               &amp;&amp; !tbnet::ConnectionManager::isAlive(sit-&gt;second-&gt;server_id)))
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 34:           || sit-&gt;second-&gt;status == server_info::FORCE_DOWN) {        <span style="color: #008000">// downhost</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 35:         change_group_info_list.insert(sit-&gt;second-&gt;group_info_data);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 36:         <span style="color: #008000">//修改dataserver的状态</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 37:         sit-&gt;second-&gt;status = server_info::DOWN;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 38:         log_warn(&quot;<span style="color: #8b0000">HOST DOWN: %s lastTime is %u now is %u </span>&quot;,
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 39:             tbsys::CNetUtil::addrToString(sit-&gt;second-&gt;server_id).
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 40:             c_str(), sit-&gt;second-&gt;last_time, heartbeat_curr_time);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 41: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 42: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 43:         <span style="color: #008000">// if (need add down server config) then set downserver in group.conf</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 44:         <span style="color: #0000ff">if</span> (sit-&gt;second-&gt;group_info_data-&gt;get_pre_load_flag() == 1)
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 45:         {   
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 46:           log_error(&quot;<span style="color: #8b0000">add down host: %s lastTime is %u now is %u </span>&quot;,
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 47:               tbsys::CNetUtil::addrToString(sit-&gt;second-&gt;server_id).
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 48:               c_str(), sit-&gt;second-&gt;last_time, heartbeat_curr_time);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 49:           sit-&gt;second-&gt;group_info_data-&gt;add_down_server(sit-&gt;second-&gt;server_id);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 50:           sit-&gt;second-&gt;group_info_data-&gt;set_force_send_table();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 51:         }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 52:       }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 53:     }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 54:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 55:   <span style="color: #008000">// only master config server can update hashtable.</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 56:   <span style="color: #0000ff">if</span>(master_config_server_id != util::local_server_ip::ip) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 57:     <span style="color: #0000ff">return</span>;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 58:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 59:   <span style="color: #008000">//以下代码只会在主配置服务器中执行</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 60:   uint64_t slave_server_id = get_slave_server_id();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 61: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 62: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 63:   group_info_rw_locker.rdlock();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 64:   <span style="color: #008000">//需要检查是否数据迁移的相关状态，目前我还不明白hard check 和 check纠结各自目标是什么，这里后面慢慢分析</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 65:   <span style="color: #0000ff">if</span>(loop_count % HARD_CHECK_MIG_COMPLETE == 0) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 66:     <span style="color: #0000ff">for</span>(group_info_map::const_iterator it = group_info_map_data.begin();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 67:         it != group_info_map_data.end(); it++) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 68:       it-&gt;second-&gt;hard_check_migrate_complete(slave_server_id);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 69:     }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 70:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 71: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 72: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 73:   <span style="color: #0000ff">for</span>(it = group_info_map_data.begin(); it != group_info_map_data.end();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 74:       ++it) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 75:     it-&gt;second-&gt;check_migrate_complete(slave_server_id);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 76: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 77: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 78:     <span style="color: #008000">// check if send server_table</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 79:     <span style="color: #0000ff">if</span> (1 == it-&gt;second-&gt;get_send_server_table())
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 80:     {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 81:       log_warn(&quot;<span style="color: #8b0000">group: %s need send server table</span>&quot;, it-&gt;second-&gt;get_group_name());
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 82:       it-&gt;second-&gt;send_server_table_packet(slave_server_id);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 83:       it-&gt;second-&gt;reset_force_send_table();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 84:     }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 85:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 86: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 87: 
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 88:   <span style="color: #0000ff">if</span>(change_group_info_list.size() == 0U) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 89:     group_info_rw_locker.unlock();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 90:     <span style="color: #0000ff">return</span>;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 91:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 92:   <span style="color: #008000">//收集需要重建对照表的group, 将group添加到builder_thread线程中</span>
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 93:   set&lt;group_info *&gt;::iterator cit;
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 94:   tbsys::CThreadGuard guard(&amp;mutex_grp_need_build);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 95:   <span style="color: #0000ff">for</span>(cit = change_group_info_list.begin();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 96:       cit != change_group_info_list.end(); ++cit) {
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 97:     builder_thread.group_need_build.push_back(*cit);
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff"> 98:     (*cit)-&gt;set_table_builded();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0"> 99:   }
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #ffffff">100:   group_info_rw_locker.unlock();
</pre><pre style="font-size: 13px; font-family: consolas,&#39;Courier New&#39;,courier,monospace; margin: 0em; width: 100%; background-color: #c0c0c0">101: }</pre></pre>
##小结
本节比较粗略的描述了configserver工作状态。在configserver中，所谓的对照表是一个非常重要的事物，下一节讲描述configserver是如何创建对照表。TAIR源码分析<二>。
